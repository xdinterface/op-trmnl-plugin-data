name: Update current.json

on:
  schedule:
    # Run daily at 00:01 UTC to trigger TRMNL re-render
    - cron: '1 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-current:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update monthly file (1st of month only)
        run: |
          DAY=$(date -u +%d)
          MONTH=$(date -u +%m)

          # Only swap monthly file on the 1st of the month
          if [ "$DAY" = "01" ]; then
            echo "First of month - updating to new monthly file"

            # Map month number to filename
            declare -A MONTHS=(
              ["01"]="01-january"
              ["02"]="02-february"
              ["03"]="03-march"
              ["04"]="04-april"
              ["05"]="05-may"
              ["06"]="06-june"
              ["07"]="07-july"
              ["08"]="08-august"
              ["09"]="09-september"
              ["10"]="10-october"
              ["11"]="11-november"
              ["12"]="12-december"
            )

            MONTHLY_FILE="data/monthly/${MONTHS[$MONTH]}.json"

            echo "Current month: $MONTH"
            echo "Copying $MONTHLY_FILE to data/current.json"

            if [ -f "$MONTHLY_FILE" ]; then
              cp "$MONTHLY_FILE" data/current.json
              echo "Updated current.json with $(grep -c '"name"' data/current.json) characters"
            else
              echo "Error: $MONTHLY_FILE not found"
              exit 1
            fi
          else
            echo "Not first of month (day=$DAY) - skipping monthly file swap"
          fi

      - name: Add last_updated timestamp
        run: |
          # Inject current UTC timestamp to force TRMNL re-render
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "Adding last_updated: $TIMESTAMP"
          jq --arg date "$TIMESTAMP" '.last_updated = $date' data/current.json > tmp.json
          mv tmp.json data/current.json

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/current.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Daily update: $(date -u +%Y-%m-%d)"
            git push
          fi
